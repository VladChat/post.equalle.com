# ============================================================
# File: .github/workflows/instagram-production-chain.yml
# Workflow: Instagram Production Chain (Flag-protected)
#
# Purpose:
#   - Запускается автоматически после успешного pages-build-deployment
#   - Проверяет флаг data/flags/ready_for_instagram.flag
#   - Если флаг существует → публикует пост в Instagram (MODE=prod)
#   - После публикации удаляет флаг из репозитория (git commit + push)
# ============================================================

name: Instagram Production Chain

on:
  workflow_run:
    workflows: ["pages-build-deployment"]
    types: [completed]

permissions:
  contents: write

jobs:
  publish:
    # Запуск только если pages-build-deployment завершился успехом
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:

      # -----------------------------------------
      # 1. Checkout repository
      # -----------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # -----------------------------------------
      # 2. Check if Instagram publish flag exists
      # -----------------------------------------
      - name: Check Instagram flag
        id: checkflag
        run: |
          if [ -f data/flags/ready_for_instagram.flag ]; then
            echo "Flag found → will publish"
            echo "publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "Flag not found → skipping publish"
            echo "publish=false" >> "$GITHUB_OUTPUT"
          fi

      # -----------------------------------------
      # 3. Setup Python (only if flag present)
      # -----------------------------------------
      - name: Set up Python
        if: steps.checkflag.outputs.publish == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      # -----------------------------------------
      # 4. Install dependencies (requests, pillow)
      # -----------------------------------------
      - name: Install dependencies
        if: steps.checkflag.outputs.publish == 'true'
        run: pip install requests pillow

      # -----------------------------------------
      # 5. Publish Instagram post
      # -----------------------------------------
      - name: Publish Instagram Post (PROD)
        if: steps.checkflag.outputs.publish == 'true'
        env:
          MODE: "prod"
          IG_BUSINESS_ID: ${{ secrets.IG_BUSINESS_ID }}
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
          IG_IMAGES_BASE_URL: "https://post.equalle.com/images/ig"
        run: python -m scripts.instagram.post_to_instagram

      # -----------------------------------------
      # 6. Remove flag and commit changes
      # -----------------------------------------
      - name: Remove flag (commit & push)
        if: steps.checkflag.outputs.publish == 'true'
        run: |
          # Настраиваем git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # Удаляем флаг
          rm -f data/flags/ready_for_instagram.flag

          # Добавляем изменения в индекс
          git add -u data/flags/ready_for_instagram.flag || true

          # Пытаемся коммитнуть
          git commit -m "Remove Instagram publish flag" || echo "Nothing to commit"

          # Пушим (не ломаемся, если нечего пушить)
          git push || true

      # -----------------------------------------
      # 7. Finish
      # -----------------------------------------
      - name: Done
        run: echo "Instagram Production Chain finished."
