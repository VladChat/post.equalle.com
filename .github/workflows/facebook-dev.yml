# ============================================================
# File: .github/workflows/facebook-dev.yml
# Purpose: Run Facebook auto-poster in DEV mode (no publishing)
# Output: data/out/facebook_preview.json (committed to repo)
#         docs/preview/facebook.html (visual preview on Pages)
# ============================================================

name: Auto Post (Facebook DEV)

on:
  workflow_dispatch:        # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub Actions
  # schedule:
  #   - cron: '0 14 * * *'    # –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 14:00 UTC (~08:00 CST)

permissions:
  contents: write            # —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –∫–æ–º–º–∏—Ç–∏—Ç—å —Ñ–∞–π–ª—ã –≤ repo

jobs:
  facebook_dev:
    runs-on: ubuntu-latest

    steps:
      # === 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Checkout repository
        uses: actions/checkout@v4

      # === 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω Facebook API ===
      - name: Check Facebook API connection
        env:
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        run: |
          set -x
          echo "üîé Checking Facebook API token at $(date)"
          curl -s -w "\nHTTP_STATUS:%{http_code}\n" -o /tmp/fb_check.json \
            "https://graph.facebook.com/v21.0/me?access_token=$FB_PAGE_TOKEN" | tee /tmp/fb_check_raw.log
          echo "üìÑ Raw response:"; cat /tmp/fb_check.json
          if grep -q '"id"' /tmp/fb_check.json; then
            echo "‚úÖ Token valid and API reachable."
          else
            echo "‚ùå Token invalid or expired!"; exit 1
          fi

      # === 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # === 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ===
      - name: Install dependencies
        run: |
          set -x
          pip install -r requirements.txt --quiet
          pip list

      # === 5. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–æ—Å—Ç–µ—Ä –≤ DEV —Ä–µ–∂–∏–º–µ ===
      - name: Run Facebook auto poster (DEV mode)
        env:
          MODE: dev
        run: |
          set -x
          mkdir -p data/out data/logs
          python -m scripts.post_to_facebook 2>&1 | tee data/logs/dev_run.log
          echo "ü™µ Tail dev_run.log:"; tail -n 30 data/logs/dev_run.log || true

      # === 6. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –≤ –ª–æ–≥–∞—Ö ===
      - name: Show generated preview
        run: |
          echo "üßæ Generated preview file:"
          if [ -f data/out/facebook_preview.json ]; then
            cat data/out/facebook_preview.json
          else
            echo "‚ùå No preview file found"; exit 1
          fi

      # === 7. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML-–ø—Ä–µ–≤—å—é –¥–ª—è GitHub Pages ===
      - name: Generate visual Facebook preview (HTML)
        run: |
          echo "üñº Generating visual preview..."
          mkdir -p docs/preview
          python - <<'PYCODE'
import json, html, os
os.makedirs("docs/preview", exist_ok=True)
with open("data/out/facebook_preview.json", "r", encoding="utf-8") as f:
    post = json.load(f)
html_content = f"""<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8">
<title>Facebook Post Preview ‚Äì DEV</title>
<style>
body {{ background:#f0f2f5; font-family:Arial, sans-serif; display:flex; justify-content:center; padding:40px; }}
.card {{ width:520px; background:#fff; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; }}
.header {{ display:flex; align-items:center; padding:12px 16px; }}
.avatar {{ width:40px; height:40px; border-radius:50%; background:#ddd; margin-right:10px; }}
.title {{ font-weight:700; font-size:15px; color:#050505; }}
.time {{ font-size:13px; color:#65676b; }}
.content {{ padding:16px; white-space:pre-wrap; color:#050505; font-size:15px; line-height:1.5; }}
img {{ width:100%; height:auto; display:block; }}
.link {{ padding:12px 16px; background:#f0f2f5; border-top:1px solid #ddd; }}
.link a {{ color:#385898; text-decoration:none; font-size:14px; }}
.link a:hover {{ text-decoration:underline; }}
</style></head><body>
  <div class="card">
    <div class="header"><div class="avatar"></div>
      <div><div class="title">Abrasive Sanding Paper</div><div class="time">Just now ¬∑ üåç</div></div>
    </div>
    <div class="content"><strong>{html.escape(post.get('title',''))}</strong>

{html.escape(post.get('caption',''))}</div>
    <img src="{html.escape(post.get('image',''))}" alt="preview">
    <div class="link"><a href="{html.escape(post.get('link',''))}" target="_blank">blog.equalle.com ¬∑ Article</a></div>
  </div>
</body></html>"""
with open("docs/preview/facebook.html", "w", encoding="utf-8") as f:
    f.write(html_content)
print("‚úÖ Visual preview saved to docs/preview/facebook.html")
PYCODE

      # === 8. –ö–æ–º–º–∏—Ç–∏–º –ø—Ä–µ–≤—å—é –∏ –ª–æ–≥–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Commit preview to repo
        run: |
          set -x
          git config user.name "actions-user"
          git config user.email "actions@github.com"
          git add data/out/facebook_preview.json data/logs/dev_run.log docs/preview/facebook.html
          git commit -m "Auto-update Facebook preview (DEV) + HTML" || echo "No changes to commit"
          git push
