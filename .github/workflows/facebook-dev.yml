# ============================================================
# File: .github/workflows/facebook-dev.yml
# Purpose:
#   Run Facebook auto-poster in DEV mode (no publishing)
#   Validate API connection, show full logs, generate HTML preview,
#   and publish it to GitHub Pages at /preview/facebook.html
# ============================================================

name: Facebook Auto Poster (DEV)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  facebook_dev:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Facebook API connection
        env:
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        run: |
          set -x
          echo "üîé Checking Facebook API token at $(date)"
          curl -s -w "\nHTTP_STATUS:%{http_code}\n" -o /tmp/fb_check.json \
            "https://graph.facebook.com/v21.0/me?access_token=$FB_PAGE_TOKEN" | tee /tmp/fb_check_raw.log
          echo "üìÑ Raw response:"
          cat /tmp/fb_check.json
          if grep -q '"id"' /tmp/fb_check.json; then
            echo "‚úÖ Token valid and API reachable."
          else
            echo "‚ùå Token invalid or expired!"
            exit 1
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          set -x
          echo "üì¶ Installing dependencies at $(date)"
          pip install -r requirements.txt --quiet
          pip list

      - name: Verify directory structure
        run: |
          echo "üìÇ Repository contents before run:"
          find . -maxdepth 3 -type f | sort

      - name: Run Facebook auto poster (DEV mode)
        env:
          MODE: dev
        run: |
          set -x
          echo "üöÄ Running post_to_facebook.py in DEV mode at $(date)"
          mkdir -p data/out data/logs
          python -m scripts.post_to_facebook 2>&1 | tee data/logs/dev_run.log
          tail -n 20 data/logs/dev_run.log || true

      - name: Check generated preview
        run: |
          if [ -f data/out/facebook_preview.json ]; then
            echo "‚úÖ Preview file exists:"
            cat data/out/facebook_preview.json
          else
            echo "‚ùå Preview file not found!"
            exit 1
          fi

      - name: Generate visual Facebook preview (HTML)
        run: |
          echo "üñº Generating visual preview..."
          mkdir -p docs/preview
          python - <<'PYCODE'
import json, html, os
os.makedirs("docs/preview", exist_ok=True)
with open("data/out/facebook_preview.json", "r", encoding="utf-8") as f:
    post = json.load(f)

html_content = f"""<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Facebook Post Preview ‚Äì DEV</title>
<style>
body {{ background:#f0f2f5; font-family:Arial,sans-serif; display:flex; justify-content:center; }}
.card {{ width:520px; background:#fff; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); margin:40px; overflow:hidden; }}
img {{ width:100%; height:auto; display:block; }}
.content {{ padding:16px; }}
h3 {{ font-size:18px; margin:0 0 10px; color:#1c1e21; }}
p {{ white-space:pre-wrap; font-size:15px; color:#050505; line-height:1.5; }}
a {{ display:block; margin-top:10px; font-size:14px; color:#385898; text-decoration:none; }}
a:hover {{ text-decoration:underline; }}
footer {{ text-align:center; font-size:13px; color:#777; margin-top:20px; }}
</style>
</head>
<body>
  <div class="card">
    <img src="{html.escape(post['image'])}" alt="preview">
    <div class="content">
      <h3>{html.escape(post['title'])}</h3>
      <p>{html.escape(post['caption'])}</p>
      <a href="{html.escape(post['link'])}" target="_blank">Read more ‚Üí</a>
    </div>
  </div>
  <footer>Facebook DEV Preview ‚Äì generated automatically</footer>
</body>
</html>"""

with open("docs/preview/facebook.html", "w", encoding="utf-8") as f:
    f.write(html_content)
print("‚úÖ Visual preview saved to docs/preview/facebook.html")
PYCODE

      - name: Commit preview to GitHub Pages
        run: |
          set -x
          echo "üíæ Committing preview to Pages at $(date)"
          git config user.name "actions-user"
          git config user.email "actions@github.com"
          git add data/out/facebook_preview.json data/logs/dev_run.log docs/preview/facebook.html
          git commit -m "Auto-update Facebook DEV preview and HTML" || echo "No changes to commit"
          git push
