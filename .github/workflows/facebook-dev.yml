# ============================================================
# File: .github/workflows/facebook-dev.yml
# Purpose:
#   Run Facebook auto-poster in DEV mode (no publishing)
#   Validate API connection, show full logs, and commit preview JSON
# Output:
#   data/out/facebook_preview.json (committed to repo)
# ============================================================

name: Facebook Auto Poster (DEV)

on:
  workflow_dispatch:        # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ GitHub Actions
  # schedule:
  #   - cron: '0 14 * * *'    # –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 14:00 UTC (~08:00 CST)

permissions:
  contents: write            # –Ω—É–∂–Ω–æ –¥–ª—è –∫–æ–º–º–∏—Ç–∞ –ø—Ä–µ–≤—å—é –∏ –ª–æ–≥–æ–≤ –≤ repo

jobs:
  facebook_dev:
    runs-on: ubuntu-latest

    steps:
      # === 1. –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Checkout repository
        uses: actions/checkout@v4

      # === 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–∫–µ–Ω Facebook API ===
      - name: Check Facebook API connection
        env:
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        run: |
          set -x
          echo "üîé Checking Facebook API token at $(date)"
          curl -s -w "\nHTTP_STATUS:%{http_code}\n" -o /tmp/fb_check.json \
            "https://graph.facebook.com/v21.0/me?access_token=$FB_PAGE_TOKEN" | tee /tmp/fb_check_raw.log
          echo "üìÑ Raw response:"
          cat /tmp/fb_check.json
          if grep -q '"id"' /tmp/fb_check.json; then
            echo "‚úÖ Token valid and API reachable."
          else
            echo "‚ùå Token invalid or expired!"
            exit 1
          fi

      # === 3. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # === 4. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ===
      - name: Install dependencies
        run: |
          set -x
          echo "üì¶ Installing dependencies at $(date)"
          pip install -r requirements.txt --quiet
          echo "‚úÖ Installed packages:"
          pip list

      # === 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π ===
      - name: Verify directory structure
        run: |
          echo "üìÇ Listing repository contents before running script:"
          find . -maxdepth 3 -type f | sort

      # === 6. –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–ø–æ—Å—Ç–µ—Ä –≤ DEV —Ä–µ–∂–∏–º–µ ===
      - name: Run Facebook auto poster (DEV mode)
        env:
          MODE: dev
        run: |
          set -x
          echo "üöÄ Running post_to_facebook.py in DEV mode at $(date)"
          mkdir -p data/out data/logs
          python -m scripts.post_to_facebook 2>&1 | tee data/logs/dev_run.log
          echo "üìÑ Finished running script at $(date)"
          echo "ü™µ Partial log preview:"
          tail -n 20 data/logs/dev_run.log || echo "No log file found"

      # === 7. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã —Å–∫—Ä–∏–ø—Ç–∞ ===
      - name: Check generated preview
        run: |
          echo "üßæ Checking generated preview file at $(date)"
          if [ -f data/out/facebook_preview.json ]; then
            echo "‚úÖ Preview file exists:"
            ls -lh data/out/facebook_preview.json
            echo "üìú Preview content:"
            cat data/out/facebook_preview.json
          else
            echo "‚ùå Preview file not found!"
            exit 1
          fi

      # === 8. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–ø–æ–∫ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ===
      - name: List directory contents after script
        run: |
          echo "üìÇ Listing repository contents after script run:"
          find data -type f | sort || echo "No files in data/"

      # === 9. –ö–æ–º–º–∏—Ç–∏–º –ø—Ä–µ–≤—å—é –∏ –ª–æ–≥–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Commit preview and logs to repo
        run: |
          set -x
          echo "üíæ Committing preview file and logs at $(date)"
          git config user.name "actions-user"
          git config user.email "actions@github.com"
          git add data/out/facebook_preview.json data/logs/dev_run.log || true
          git commit -m "Auto-update Facebook preview (DEV)" || echo "No changes to commit"
          git push
          echo "‚úÖ Commit process completed at $(date)"
