# ============================================================
# File: .github/workflows/instagram-post-triger.yml
# Workflow: Instagram Card Builder (RSS-aware)
# Purpose:
#   - Create instagram image card from latest RSS item
#   - Only set a publish flag if a NEW IG card was generated
# ============================================================

name: Instagram Post (Trigger Chain)

on:
  workflow_dispatch: {}   # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: "0 18 * * *"   # –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ 12:00 –ø–æ –ß–∏–∫–∞–≥–æ (18:00 UTC)

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pillow

      - name: Generate Instagram Card
        id: make_card
        run: python -m scripts.instagram.make_instagram_card

      # ============================================
      # üîé Check if a NEW card was generated
      #   (marker file created by make_instagram_card.py)
      # ============================================
      - name: Check new Instagram card marker
        id: check_card
        run: |
          if [ -f data/state/instagram_last_card.txt ]; then
            echo "newcard=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ New IG card detected, flag will be created."
          else
            echo "newcard=false" >> "$GITHUB_OUTPUT"
            echo "‚è≠Ô∏è No new IG card ‚Äî skipping flag and commit."
          fi

      # ============================================
      # üî• Create "ready for Instagram" flag (ONLY if new card)
      # ============================================
      - name: Create Instagram publish flag
        if: steps.check_card.outputs.newcard == 'true'
        run: |
          mkdir -p data/flags
          echo "ready" > data/flags/ready_for_instagram.flag
          echo "Flag ready_for_instagram.flag created."

      # ============================================
      # üî• Commit changes (card + history + state + flag), then remove marker
      # ============================================
      - name: Commit and push results
        if: steps.check_card.outputs.newcard == 'true'
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          git add images/ig/*.jpg || true

          # –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ fallback (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 slug)
          git add data/state/instagram_card_history.json || true

          # –ò–Ω–¥–µ–∫—Å —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏
          git add data/state/ig_template_index.txt || true

          # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
          git add data/flags/ready_for_instagram.flag || true

          # –£–¥–∞–ª—è–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä –∏ –∫–æ–º–º–∏—Ç–∏–º –µ–≥–æ —É–¥–∞–ª–µ–Ω–∏–µ
          rm -f data/state/instagram_last_card.txt || true
          git add -u data/state/instagram_last_card.txt || true

          git commit -m "Add new Instagram card + history + flag" || echo "No changes to commit"
          git push || true

