# ============================================================
# RSS Sync Workflow
# Purpose:
#   - Fetch blog RSS and update local cache/state in repository
#   - Commit updated data and logs back to GitHub
# ============================================================

name: RSS Sync

on:
  workflow_dispatch: {}     # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
   - cron: '0 22 * * *'    # –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 16:00 America/Chicago (22:00 UTC). –í CDT —ç—Ç–æ –±—É–¥–µ—Ç 17:00 –ø–æ –ß–∏–∫–∞–≥–æ.

permissions:
  contents: write           # ‚úÖ –Ω—É–∂–Ω–æ –¥–ª—è git push
  actions: read

jobs:
  fetch:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      # === 1Ô∏è‚É£ Checkout repository ===
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: true   # ‚úÖ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø—É—à–∞
          fetch-depth: 0

      # === 2Ô∏è‚É£ Set up Python ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # === 3Ô∏è‚É£ Install dependencies ===
      - name: Install dependencies
        run: pip install -r requirements.txt

      # === 4Ô∏è‚É£ Run RSS Fetch ===
      - name: Fetch and cache RSS posts
        run: python -m scripts.rss_fetch

      # === 5Ô∏è‚É£ Commit updated files ===
      - name: Commit updated cache/config/logs
        run: |
          echo "üßæ Checking for changes..."
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git add scripts/config.json data/cache/latest_posts.json data/state.json data/logs/rss_fetch.log || true

          if git diff --cached --quiet; then
            echo "‚úÖ No changes to commit."
          else
            echo "üì¶ Changes detected ‚Äî committing..."
            git commit -m "Auto-update RSS cache and logs"
            git push origin main
          fi
