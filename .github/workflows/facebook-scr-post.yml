# ============================================================
# File: .github/workflows/facebook-scr-post.yml
# Purpose:
#   –ü—É–±–ª–∏–∫—É–µ—Ç –ø–æ—Å—Ç—ã –Ω–∞ Facebook (—Ä–∞–±–æ—á–∏–π —Ä–µ–∂–∏–º)
#   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.
#   –°–∫—Ä–∏–Ω—à–æ—Ç—ã —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ fb_screenshot_manager.py
# ============================================================

name: Facebook Screenshot Post (PROD)

on:
  workflow_dispatch:        # —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  schedule:
    - cron: '0 15 * * 1,3,5'   # –ø–Ω, —Å—Ä, –ø—Ç –≤ 09:00 CST (15:00 UTC)

permissions:
  contents: write            # –Ω—É–∂–Ω–æ –¥–ª—è git push state.json

concurrency:
  group: facebook-scr-post
  cancel-in-progress: true

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      # === 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ===
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      # === 2Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python ===
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # === 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Selenium + Pillow) ===
      - name: Install dependencies
        run: |
          pip install -r requirements.txt || true
          pip install selenium pillow

      # === 4Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Chrome –¥–ª—è headless-—Ä–µ–∂–∏–º–∞ ===
      - name: Setup Google Chrome
        uses: browser-actions/setup-chrome@v1

      # === 5Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º Facebook –ø–æ—Å—Ç–∏–Ω–≥ –≤ PROD (—Å–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º–∏) ===
      - name: Run Facebook Screenshot Poster (PROD)
        env:
          MODE: prod
          FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN }}
        run: |
          python -m scripts.post_to_facebook

      # === 6Ô∏è‚É£ –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π state.json (—á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—ã) ===
      - name: Commit updated state.json
        run: |
          if [ -f "data/state.json" ]; then
            git config user.name "actions-user"
            git config user.email "actions@github.com"
            git add data/state.json
            git commit -m "Update published_links state (auto)" || echo "No changes"
            git push
          else
            echo "data/state.json not found; nothing to commit."
          fi

      # === 7Ô∏è‚É£ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π ===
      - name: Show log summary
        run: |
          echo "üü¢ Facebook Screenshot Poster completed successfully."
